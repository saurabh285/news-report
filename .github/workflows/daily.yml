name: Daily News Report

on:
  # Run every day at 07:00 UTC
  schedule:
    - cron: "0 7 * * *"
  # Allow manual trigger from the GitHub Actions tab
  workflow_dispatch:

jobs:
  send-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Smoke test (compile check)
        run: |
          python -m py_compile main.py
          python -m py_compile ai/__init__.py
          python -m py_compile ai/tools.py
          python -m py_compile ai/llm_client.py
          python -m py_compile ai/agent_runner.py
          python -m py_compile ai/email_template.py
          echo "All files compiled successfully."

      - name: Run Daily News Report
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}

          # ── LLM provider selection ──────────────────────────────────────────
          # Set the secret for whichever provider you want to use.
          # The provider is auto-detected from whichever key is present.
          # You can also set LLM_PROVIDER to force a specific one.

          # Gemini (free tier, default):
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

          # Anthropic Claude (optional):
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

          # OpenAI (optional):
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

          # Force a specific provider (optional — auto-detected if unset):
          # LLM_PROVIDER: ${{ secrets.LLM_PROVIDER }}

          # Force a specific model (optional — uses provider default if unset):
          # GEMINI_MODEL:    ${{ secrets.GEMINI_MODEL }}
          # ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          # OPENAI_MODEL:    ${{ secrets.OPENAI_MODEL }}
        run: python main.py
