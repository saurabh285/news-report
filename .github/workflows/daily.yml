name: Daily News Report

on:
  # Run every day at 07:00 UTC
  schedule:
    - cron: "0 7 * * *"
  # Allow manual trigger from the GitHub Actions tab
  workflow_dispatch:

jobs:
  send-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Smoke test (compile check)
        run: |
          python -m py_compile main.py
          python -m py_compile ai/__init__.py
          python -m py_compile ai/tools.py
          python -m py_compile ai/claude_client.py
          python -m py_compile ai/agent_runner.py
          echo "All files compiled successfully."

      - name: Run Daily News Report
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.EMAIL_RECIPIENT }}
          # Optional: add ANTHROPIC_API_KEY secret to enable agent mode (ai.mode: agent)
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # Optional: override the Claude model at runtime (e.g. claude-haiku-3-5)
          # Leave unset to use the model from config.yaml (default: claude-haiku-3-5)
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
        run: python main.py
